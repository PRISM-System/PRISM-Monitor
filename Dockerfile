# -------------------------------------------------------------
# 1. 기본 이미지 변경
# -------------------------------------------------------------
# NVIDIA CUDA 이미지 대신 공식 Python 3.11-slim 이미지를 사용합니다.
# 'bullseye'는 Debian 11을 의미하며, 안정적이고 가볍습니다.
FROM python:3.11-slim-bullseye

# -------------------------------------------------------------
# 2. 환경 변수 설정
# -------------------------------------------------------------
ENV PYTHONUNBUFFERED=1
ENV PIPENV_VENV_IN_PROJECT=1
# DEBIAN_FRONTEND는 apt-get 사용 시 대화형 프롬프트를 비활성화합니다.
ENV DEBIAN_FRONTEND=noninteractive

# -------------------------------------------------------------
# 3. 시스템 종속성 설치
# -------------------------------------------------------------
# Pipfile에서 git 저장소 등을 사용할 수 있으므로 git과 curl은 설치합니다.
# --no-install-recommends로 불필요한 패키지를 제외하여 용량을 줄입니다.
RUN apt-get update \
    && apt-get install -y --no-install-recommends \
        curl \
        git \
    # apt 캐시를 삭제하여 이미지 용량을 확보합니다.
    && rm -rf /var/lib/apt/lists/*

# -------------------------------------------------------------
# 4. Pipenv 설치 및 종속성 설치 (캐시 최적화)
# -------------------------------------------------------------
WORKDIR /app

# pip 자체와 pipenv를 먼저 설치합니다.
# --no-cache-dir로 pip 캐시를 남기지 않습니다.
RUN pip install --no-cache-dir --upgrade pip pipenv

# ★ Docker 캐시 최적화
# 소스 코드(.py)가 아닌 의존성 파일(Pipfile)만 먼저 복사합니다.
# 이렇게 하면 소스 코드만 변경 시, 매번 pipenv install을 다시 실행하지 않습니다.
COPY Pipfile Pipfile.lock ./

# --deploy 플래그로 Pipfile.lock을 사용해 정확한 버전의 패키지를 설치합니다.
RUN pipenv install --deploy

# -------------------------------------------------------------
# 5. 소스 코드 및 환경 파일 복사
# -------------------------------------------------------------

# .env-local 파일을 .env로 이름을 변경하여 복사합니다.
COPY .env-local .env

# 나머지 애플리케이션 소스 코드를 복사합니다.
COPY . .

# -------------------------------------------------------------
# 6. 포트 노출 및 실행
# -------------------------------------------------------------
EXPOSE 8001

# pipenv run을 사용하여 가상 환경 내에서 uvicorn을 실행합니다.
CMD ["pipenv", "run", "uvicorn", "main:app", "--host", "0.0.0.0", "--port", "8001"]